@using EllosPratas.Dto
@using EllosPratas.Dto.Loja.Entrada
@model LojaCadastroDto

@{
    ViewData["Title"] = "Cadastrar Loja";
}

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">@ViewData["Title"]</h4>
                </div>
                <div class="card-body">
                    <form id="lojasForm" asp-controller="Loja" asp-action="Cadastrar" method="post">
                        @Html.AntiForgeryToken()

                        <h5>Dados da Loja</h5>
                        <hr />
                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label asp-for="nome_loja" class="form-label">Nome da Loja</label>
                                <input asp-for="nome_loja" class="form-control" id="nome_loja" />
                                <span asp-validation-for="nome_loja" class="text-danger"></span>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label asp-for="telefone" class="form-label">Telefone</label>
                                <input asp-for="telefone" class="form-control" id="telefone" />
                                <span asp-validation-for="telefone" class="text-danger"></span>
                            </div>
                        </div>

                        <h5 class="mt-4">Endereço</h5>
                        <hr />
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="id_estado" class="form-label">Estado</label>
                                <select asp-for="id_estado" class="form-select" id="select-estado"></select>
                                <span asp-validation-for="id_estado" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="id_cidade" class="form-label">Cidade</label>
                                <select asp-for="id_cidade" class="form-select" id="select-cidade" disabled></select>
                                <span asp-validation-for="id_cidade" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="rua" class="form-label">Rua</label>
                                <input asp-for="rua" class="form-control" id="rua" />
                                <span asp-validation-for="rua" class="text-danger"></span>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label asp-for="bairro" class="form-label">Bairro</label>
                                <input asp-for="bairro" class="form-control" id="bairro" />
                                <span asp-validation-for="bairro" class="text-danger"></span>
                            </div>
                            <div class="col-md-2 mb-3">
                                <label asp-for="numero" class="form-label">Número</label>
                                <input asp-for="numero" class="form-control" id="numero" />
                                <span asp-validation-for="numero" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                            <a asp-action="Index" class="btn btn-outline-secondary">Cancelar</a>
                            <button type="submit" class="btn btn-primary">Cadastrar Loja</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        $(document).ready(function() {
            const selectEstado = $('#select-estado');
            const selectCidade = $('#select-cidade');

            selectEstado.select2({
                theme: 'bootstrap-5',
                placeholder: 'Digite para buscar um estado',
                ajax: {
                    url: '@Url.Action("ListarEstados", "Loja")',
                    dataType: 'json',
                    delay: 250,
                    processResults: function (data) {
                        return {
                            results: data
                        };
                    },
                    cache: true
                }
            });

            selectCidade.select2({
                theme: 'bootstrap-5',
                placeholder: 'Primeiro, selecione um estado'
            });

            selectEstado.on('select2:select', function (e) {
                const estadoId = e.params.data.id;

                selectCidade.val(null).trigger('change');
                selectCidade.prop('disabled', false);

                selectCidade.select2({
                    theme: 'bootstrap-5',
                    placeholder: 'Digite para buscar uma cidade',
                     ajax: {
                        url: '@Url.Action("ListarCidades", "Loja")',
                        dataType: 'json',
                        data: function(params) {
                            return {
                                estadoId: estadoId,
                                q: params.term
                            };
                        },
                        delay: 250,
                        processResults: function (data) {
                            return {
                                results: data
                            };
                        },
                        cache: true
                    }
                });
            });

            $('#lojasForm').on('submit', function (e) {
                e.preventDefault();

                // Captura o token CSRF
                var token = $('input[name="__RequestVerificationToken"]').val();

                // Captura os valores diretamente dos campos
                var formData = {
                    __RequestVerificationToken: token,
                    nome_loja: $('#nome_loja').val(),
                    telefone: $('#telefone').val(),
                    rua: $('#rua').val(),
                    bairro: $('#bairro').val(),
                    numero: $('#numero').val(),
                    id_estado: selectEstado.val(),
                    id_cidade: selectCidade.val()
                };

                console.log("=== Dados sendo enviados ===");
                console.log(formData);

                $.ajax({
                    type: 'POST',
                    url: '@Url.Action("Cadastrar", "Loja")',
                    data: formData,
                    success: function(response) {
                        console.log("Retorno: ", response);

                        if (response.success) {
                            alert(response.message);
                            $('#lojasForm')[0].reset();
                            selectEstado.val(null).trigger('change');
                            selectCidade.val(null).trigger('change').prop('disabled', true);
                       } else {
                            alert(response.message);
                       }
                    },
                    error: function(xhr, status, error) {
                        console.log("Erro completo: ", xhr);
                        var response = xhr.responseJSON;
                        if (response && response.message) {
                            alert(response.message);
                        } else {
                            alert("Ocorreu um erro inesperado. Tente novamente.");
                        }
                    }
                });
            });
        });
    </script>
}