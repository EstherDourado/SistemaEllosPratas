@using EllosPratas.Dto
@model FuncionarioDto

@{
    bool isEditMode = Model != null && Model.id_funcionario > 0;
    ViewData["Title"] = isEditMode ? "Editar Funcionário" : "Cadastrar Funcionário";
    var actionName = isEditMode ? "Editar" : "Cadastrar";
    var lojas = ViewBag.Lojas as SelectList;
    var niveisAcesso = ViewBag.NiveisAcesso as SelectList;
}

<div class="container mt-5">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">@ViewData["Title"]</h4>
        </div>
        <div class="card-body">
            
           <form id="funcionarioForm" asp-controller="Funcionarios" asp-action="@actionName" asp-route-id="" method="post">
                @if (isEditMode)
                {
                    <input type="hidden" asp-for="id_funcionario" />
                }
                
                @Html.AntiForgeryToken()

                <div class="row">
                    <div class="col-md-12">
                        
                        <div class="mb-3">
                            <label asp-for="nome" class="form-label"></label>
                            <input asp-for="nome" class="form-control" required>
                            <span asp-validation-for="nome" class="text-danger"></span>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="cpf" class="form-label"></label>
                                <input asp-for="cpf" id="cpf" class="form-control" required placeholder="000.000.000-00">
                                <span asp-validation-for="cpf" class="text-danger"></span>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label asp-for="id_loja" class="form-label"></label>
                                <select asp-for="id_loja" class="form-select" asp-items="lojas" required>
                                    <option value="">Selecione a Loja</option>
                                </select>
                                <span asp-validation-for="id_loja" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="id_nivel_acesso" class="form-label"></label>
                            <select asp-for="id_nivel_acesso" class="form-select" asp-items="niveisAcesso" required>
                                <option value="">Selecione o Nível de Acesso</option>
                            </select>
                            <span asp-validation-for="id_nivel_acesso" class="text-danger"></span>
                        </div>
                        
                    </div>
                </div>

                <hr />
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <a href="/Funcionarios/Index" class="btn btn-outline-secondary">Cancelar</a>
                    <button type="submit" class="btn btn-primary">@(isEditMode ? "Salvar Alterações" : "Cadastrar Funcionário")</button>
                </div>
            </form>

        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    <script>
        $(document).ready(function(){
            // Máscara para CPF
            $('#cpf').mask('000.000.000-00', {reverse: true});
            
            // Máscara de telefone (opcional, removida pois não está no DTO, mas pode ser adicionada)
            // $('#telefone').mask('(00) 00000-0000');

            $('#funcionarioForm').on('submit', function(e) {
                e.preventDefault();

                var postUrl = $(this).attr('action');
                var formData = $(this).serialize();

                $.ajax({
                    type: 'POST',
                    url: postUrl,
                    data: formData,
                    success: function(response) {
                        if (response.success) {
                            alert(response.message);
                            // Redireciona para a listagem após o sucesso
                            window.location.href = '@Url.Action("Index", "Funcionarios")';
                        }
                    },
                    error: function(xhr, status, error) {
                        var response = xhr.responseJSON;
                        var errorMessage = "Ocorreu um erro inesperado. Tente novamente.";

                        if (response) {
                            if (response.message) {
                                errorMessage = response.message;
                            } 
                            else {
                                // Lida com erros de validação do ModelState
                                var errors = [];
                                for (var key in response) {
                                    if (response[key] && Array.isArray(response[key])) {
                                        errors.push(response[key].join(' '));
                                    }
                                }
                                if (errors.length > 0) {
                                    errorMessage = errors.join('\n');
                                }
                            }
                        } else if (xhr.responseText) {
                            errorMessage = "Erro recebido do servidor. Verifique o console para mais detalhes.";
                            console.error(xhr.responseText);
                        }

                        alert(errorMessage);
                    }
                });
            });
        });
    </script>
}