@using System.Globalization
@using EllosPratas.Dto
@using EllosPratas.Dto.CarrinhoVenda.Entrada
@using EllosPratas.Dto.CarrinhoVenda.Saida
@model List<CarrinhoItemDto>
@{
    ViewData["Title"] = "Registro de Nova Venda";
    decimal totalVenda = Model.Sum(item => item.Subtotal);
}

<div class="container my-4">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h2 class="h4 mb-0"><i class="bi bi-cart-plus-fill me-2"></i>@ViewData["Title"]</h2>
        </div>
        <div class="card-body">
            <form id="form-registrar-venda">

                <fieldset class="border p-3 rounded mb-4">
                    <legend class="float-none w-auto px-2 h6">Informações Gerais</legend>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="select-funcionario" class="form-label"><b>Funcionário</b> <span class="text-danger">*</span></label>
                            <select id="select-funcionario" class="form-select" required>
                                <option value="" selected disabled>Selecione um funcionário...</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="search-cliente" class="form-label"><b>Cliente</b> (Opcional)</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" id="search-cliente" class="form-control" placeholder="Buscar cliente por nome ou CPF...">
                                <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#modalNovoCliente">
                                    <i class="bi bi-plus-lg"></i> Cadastrar
                                </button>
                            </div>
                        </div>
                    </div>
                </fieldset>

                <fieldset class="border p-3 rounded mb-4">
                    <legend class="float-none w-auto px-2 h6">Itens da Venda</legend>
                    <div class="mb-3">
                        <label for="search-produto" class="form-label"><b>Adicionar Produto</b></label>
                        <a href="@Url.Action("Index", "Produtos", new { abrirCarrinho = true })" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-plus-lg">Adicionar Mais Produtos</i>
                        </a>
                    </div>

                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-hover align-middle" id="tabela-itens-venda">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>Produto</th>
                                    <th class="text-center">Quantidade</th>
                                    <th class="text-end">Valor Unitário</th>
                                    <th class="text-end">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (!Model.Any())
                                {
                                    <tr><td colspan="4" class="text-center text-muted py-3">Nenhum item na venda. Adicione produtos pelo catálogo.</td></tr>
                                }
                                else
                                {
                                    @foreach (var item in Model)
                                    {
                                        <tr>
                                            <td>@item.NomeProduto</td>
                                            <td class="text-center">@item.Quantidade</td>
                                            <td class="text-end">@item.ValorUnitario.ToString("C")</td>
                                            <td class="text-end fw-bold">@item.Subtotal.ToString("C")</td>
                                        </tr>
                                    }
                                }
                            </tbody>
                            @if (Model.Any())
                            {
                                <tfoot class="table-group-divider">
                                    <tr>
                                        <td colspan="3" class="text-end fs-5 fw-bold">Total dos Itens:</td>
                                        <td class="text-end fs-5 fw-bold">@totalVenda.ToString("C")</td>
                                    </tr>
                                </tfoot>
                            }
                        </table>
                    </div>
                </fieldset>

                <div class="row">
                    <div class="col-lg-7">
                        <fieldset class="border p-3 rounded mb-4">
                            <legend class="float-none w-auto px-2 h6">Opções</legend>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="check-encomenda">
                                <label class="form-check-label" for="check-encomenda"><b>É uma encomenda?</b> (Cliente se torna obrigatório)</label>
                            </div>
                        </fieldset>
                    </div>
                    <div class="col-lg-5">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title mb-3">Resumo e Pagamento</h5>
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        Subtotal
                                        <span id="resumo-subtotal">R$ 0,00</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        Desconto
                                        <div class="input-group" style="width: 120px;">
                                            <span class="input-group-text">R$</span>
                                            <input type="number" id="input-desconto" class="form-control" value="0.00" min="0">
                                        </div>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center fw-bold fs-4">
                                        TOTAL
                                        <span id="resumo-total" class="text-success">R$ 0,00</span>
                                    </li>
                                </ul>
                                <hr>
                                <div class="mb-3">
                                    <label for="select-pagamento" class="form-label"><b>Forma de Pagamento</b> <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <select id="select-pagamento" class="form-select" required>
                                            <option value="" selected disabled>Selecione...</option>
                                        </select>
                                        <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#modalNovaFormaPagamento">
                                            <i class="bi bi-plus-lg"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="mb-3" id="div-parcelas" style="display: none;">
                                    <label for="select-parcelas" class="form-label"><b>Parcelas</b></label>
                                    <select id="select-parcelas" class="form-select">
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-end mt-4">
                    <button type="button" class="btn btn-secondary me-2">Limpar Campos</button>
                    <button type="submit" class="btn btn-primary"><i class="bi bi-check-circle-fill me-2"></i>Registrar Venda</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modalNovoCliente" tabindex="-1" aria-labelledby="modalNovoClienteLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalNovoClienteLabel">Cadastro Rápido de Cliente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary">Salvar Cliente</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Nova Forma de Pagamento (com campos) -->
<div class="modal fade" id="modalNovaFormaPagamento" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nova Forma de Pagamento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="form-nova-forma-pagamento">
                    <div class="mb-3">
                        <label for="nome_forma" class="form-label">Nome</label>
                        <input type="text" id="nome_forma" name="nome_forma" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="descricao_forma" class="form-label">Descrição (Opcional)</label>
                        <textarea id="descricao_forma" name="descricao" class="form-control" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" id="btn-salvar-forma-pagamento" class="btn btn-primary">Salvar</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
        function formatCurrency(value) {
            return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        function getSubtotalFromTable() {
            let subtotal = 0;
            $('#tabela-itens-venda tr').each(function() {
                const qtd = parseInt($(this).data('quantidade')) || 0;
                const valorUnitario = parseFloat($(this).data('valor-unitario')) || 0;
                subtotal += qtd * valorUnitario;
            });
            return subtotal;
        }

        function calcularTotais() {
                let subtotal = getSubtotalFromTable();
                let valorDescontoFinal = 0;
                let descontoInput = $('#input-desconto').val().trim();

                if (descontoInput === "10" || descontoInput === "15") {
                    valorDescontoFinal = (subtotal * parseFloat(descontoInput)) / 100;
                } else {
                    valorDescontoFinal = parseFloat(descontoInput.replace("R$", "").replace(/\./g, '').replace(",", ".")) || 0;
                }

                let totalFinal = subtotal - valorDescontoFinal;

                $('#resumo-subtotal').text(formatCurrency(subtotal)); // Subtotal é o valor bruto
                $('#resumo-total').text(formatCurrency(totalFinal));
        }

        async function carregarFormasPagamento() {
            const select = $('#select-pagamento');
            select.prop('disabled', true).html('<option>A carregar...</option>');
            try {
                const response = await fetch('@Url.Action("ListarFormasPagamento", "Vendas")');
                if (!response.ok) throw new Error('Falha ao carregar formas de pagamento');
                const formas = await response.json();

                select.empty().append('<option value="" selected disabled>Selecione...</option>');
                formas.forEach(forma => {
                    select.append(new Option(forma.nome_forma, forma.id_forma_pagamento));
                });
                select.prop('disabled', false);
            } catch (error) {
                console.error(error);
                select.html('<option>Erro ao carregar</option>');
            }
        }

        $('#btn-salvar-forma-pagamento').on('click', async function() {
            const form = $('#form-nova-forma-pagamento');
            if (!form[0].checkValidity()) {
                form[0].reportValidity();
                return;
            }

            const dto = {
                nome_forma: $('#nome_forma').val(),
                descricao: $('#descricao_forma').val()
            };

            try {
                const response = await fetch('@Url.Action("CadastrarFormaPagamento", "Vendas")', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dto)
                });

                if (!response.ok) throw new Error('Falha ao salvar');

                const novaForma = await response.json();

                const option = new Option(novaForma.nome_forma, novaForma.id_forma_pagamento, true, true);
                $('#select-pagamento').append(option).trigger('change');

                var modal = bootstrap.Modal.getInstance(document.getElementById('modalNovaFormaPagamento'));
                modal.hide();
                form[0].reset();
            } catch (error) {
                alert("Ocorreu um erro ao salvar a forma de pagamento.");
                console.error(error);
            }
        });

        $('#input-desconto').on('keyup change', calcularTotais);

        // Carga Inicial
        calcularTotais();
        carregarFormasPagamento();
    });
    </script>
}