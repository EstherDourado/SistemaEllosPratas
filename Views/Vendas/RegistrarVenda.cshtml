@{
    ViewData["Title"] = "Registro de Nova Venda";
}

<div class="container my-4">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h2 class="h4 mb-0"><i class="bi bi-cart-plus-fill me-2"></i>@ViewData["Title"]</h2>
            <a href="@Url.Action("Index", "Produtos", new { abrirCarrinho = true })" class="btn btn-sm btn-light">
                <i class="bi bi-plus-lg"></i> Adicionar Produtos
            </a>
        </div>
        <div class="card-body">
            <form id="form-registrar-venda">

                <fieldset class="border p-3 rounded mb-4">
                    <legend class="float-none w-auto px-2 h6">Informações Gerais</legend>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="select-funcionario" class="form-label"><b>Funcionário</b> <span class="text-danger">*</span></label>
                            <select id="select-funcionario" class="form-select" required>
                                <option value="" selected disabled>Selecione um funcionário...</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="search-cliente" class="form-label"><b>Cliente</b> (Opcional)</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" id="search-cliente" class="form-control" placeholder="Buscar cliente por nome ou CPF...">
                                <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#modalNovoCliente">
                                    <i class="bi bi-plus-lg"></i> Cadastrar
                                </button>
                            </div>
                        </div>
                    </div>
                </fieldset>

                <fieldset class="border p-3 rounded mb-4">
                    <legend class="float-none w-auto px-2 h6">Itens da Venda</legend>
                    <div class="mb-3">
                        <label for="search-produto" class="form-label"><b>Adicionar Produto</b></label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" id="search-produto" class="form-control" placeholder="Buscar produto por nome ou código...">
                        </div>
                    </div>

                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-hover align-middle">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>Produto</th>
                                    <th style="width: 150px;">Quantidade</th>
                                    <th class="text-end">Vlr. Unitário</th>
                                    <th class="text-end">Subtotal</th>
                                    <th class="text-center">Ação</th>
                                </tr>
                            </thead>
                            <tbody id="tabela-itens-venda">
                            </tbody>
                        </table>
                    </div>
                </fieldset>

                <div class="row">
                    <div class="col-lg-7">
                        <fieldset class="border p-3 rounded mb-4">
                            <legend class="float-none w-auto px-2 h6">Opções</legend>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="check-encomenda">
                                <label class="form-check-label" for="check-encomenda"><b>É uma encomenda?</b> (Cliente se torna obrigatório)</label>
                            </div>
                        </fieldset>
                    </div>
                    <div class="col-lg-5">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title mb-3">Resumo e Pagamento</h5>
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        Subtotal
                                        <span id="resumo-subtotal">R$ 0,00</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        Desconto
                                        <div class="input-group" style="width: 120px;">
                                            <span class="input-group-text">R$</span>
                                            <input type="number" id="input-desconto" class="form-control" value="0.00" min="0">
                                        </div>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center fw-bold fs-4">
                                        TOTAL
                                        <span id="resumo-total" class="text-success">R$ 0,00</span>
                                    </li>
                                </ul>
                                <hr>
                                <div class="mb-3">
                                    <label for="select-pagamento" class="form-label"><b>Forma de Pagamento</b> <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <select id="select-pagamento" class="form-select" required>
                                            <option value="" selected disabled>Selecione...</option>
                                        </select>
                                        <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#modalNovaFormaPagamento">
                                            <i class="bi bi-plus-lg"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="mb-3" id="div-parcelas" style="display: none;">
                                    <label for="select-parcelas" class="form-label"><b>Parcelas</b></label>
                                    <select id="select-parcelas" class="form-select">
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-end mt-4">
                    <button type="button" class="btn btn-secondary me-2">Limpar Campos</button>
                    <button type="submit" class="btn btn-primary"><i class="bi bi-check-circle-fill me-2"></i>Registrar Venda</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modalNovoCliente" tabindex="-1" aria-labelledby="modalNovoClienteLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalNovoClienteLabel">Cadastro Rápido de Cliente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary">Salvar Cliente</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalNovaFormaPagamento" tabindex="-1" aria-labelledby="modalNovaFormaPagamentoLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalNovaFormaPagamentoLabel">Nova Forma de Pagamento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary">Salvar</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
               document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('form-registrar-venda');
            const tabelaItens = document.getElementById('tabela-itens-venda');
            // Adicione outros seletores aqui...

            // FUNÇÃO PARA ATUALIZAR OS TOTAIS
            function calcularTotais() {
                let subtotal = 0;
                tabelaItens.querySelectorAll('tr').forEach(row => {
                    const subtotalCell = row.querySelector('.subtotal-item').textContent;
                    subtotal += parseFloat(subtotalCell.replace('R$ ', '').replace(',', '.'));
                });

                const desconto = parseFloat(document.getElementById('input-desconto').value) || 0;
                const total = subtotal - desconto;

                document.getElementById('resumo-subtotal').textContent = `R$ ${subtotal.toFixed(2).replace('.', ',')}`;
                document.getElementById('resumo-total').textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
            }

            // SIMULAÇÃO: ADICIONAR ITEM QUANDO SELECIONADO NA BUSCA
            // No seu projeto real, isso viria de uma chamada AJAX
            function adicionarItem(produto) {
                const newRow = `
                    <tr data-produto-id="${produto.id}">
                        <td>${produto.nome}</td>
                        <td>
                            <div class="input-group">
                                <button class="btn btn-outline-secondary btn-sm btn-diminuir" type="button">-</button>
                                <input type="number" class="form-control form-control-sm text-center quantidade-item" value="1" min="1">
                                <button class="btn btn-outline-secondary btn-sm btn-aumentar" type="button">+</button>
                            </div>
                        </td>
                        <td class="text-end">${produto.preco.toFixed(2).replace('.', ',')}</td>
                        <td class="text-end subtotal-item">R$ ${produto.preco.toFixed(2).replace('.', ',')}</td>
                        <td class="text-center">
                            <button class="btn btn-danger btn-sm btn-remover-item" type="button"><i class="bi bi-trash"></i></button>
                        </td>
                    </tr>
                `;
                tabelaItens.insertAdjacentHTML('beforeend', newRow);
                calcularTotais();
            }

            // Adicionando um item de exemplo para visualização
            adicionarItem({ id: 1, nome: 'Colar de Prata 925', preco: 150.00 });

            // EVENTOS DE INTERAÇÃO NA TABELA
            tabelaItens.addEventListener('click', function(e) {
                // ... Lógica para botões de aumentar, diminuir e remover item
                calcularTotais(); // Recalcula sempre que houver alteração
            });

            // EVENTO DE ALTERAÇÃO NO DESCONTO
            document.getElementById('input-desconto').addEventListener('input', calcularTotais);

            // SUBMISSÃO DO FORMULÁRIO
            form.addEventListener('submit', async function(e) {
                e.preventDefault();

                const dto = {
                    FuncionarioId: parseInt(document.getElementById('select-funcionario').value),
                    // ClienteId: ... (lógica para pegar o id do cliente selecionado)
                    Itens: [],
                    FormaPagamentoId: parseInt(document.getElementById('select-pagamento').value),
                    QuantidadeParcelas: parseInt(document.getElementById('select-parcelas').value) || 1,
                    ValorDesconto: parseFloat(document.getElementById('input-desconto').value),
                    IsEncomenda: document.getElementById('check-encomenda').checked
                };

                tabelaItens.querySelectorAll('tr').forEach(row => {
                    dto.Itens.push({
                        ProdutoId: parseInt(row.dataset.produtoId),
                        Quantidade: parseInt(row.querySelector('.quantidade-item').value)
                    });
                });

                console.log('DTO a ser enviado:', dto);

                // CHAMADA PARA O CONTROLLER
                try {
                    const response = await fetch('/Vendas/RegistrarVenda', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(dto)
                    });

                    if(response.ok) {
                        alert('Venda registrada com sucesso!');
                        // Limpar o formulário ou redirecionar
                    } else {
                        alert('Erro ao registrar a venda.');
                    }
                } catch (error) {
                    console.error('Erro na requisição:', error);
                    alert('Erro de comunicação com o servidor.');
                }
            });

            function adicionarItem(produto) {
                // Verifica se o produto já está na tabela
                if ($(`#tabela-itens-venda tr[data-produto-id="${produto.id_produto}"]`).length > 0) {
                    alert('Este produto já foi adicionado à venda.');
                    return;
                }

                const newRow = `
                    <tr data-produto-id="${produto.id_produto}">
                        <td>${produto.nome_produto}</td>
                        <td>
                            <div class="input-group">
                                <button class="btn btn-outline-secondary btn-sm btn-diminuir" type="button">-</button>
                                <input type="number" class="form-control form-control-sm text-center quantidade-item" value="1" min="1" data-preco="${produto.valor_unitario}">
                                <button class="btn btn-outline-secondary btn-sm btn-aumentar" type="button">+</button>
                            </div>
                        </td>
                        <td class="text-end valor-unitario">R$ ${produto.valor_unitario.toFixed(2).replace('.', ',')}</td>
                        <td class="text-end subtotal-item">R$ ${produto.valor_unitario.toFixed(2).replace('.', ',')}</td>
                        <td class="text-center">
                            <button class="btn btn-danger btn-sm btn-remover-item" type="button"><i class="bi bi-trash"></i></button>
                        </td>
                    </tr>`;
                tabelaItens.append(newRow);
                calcularTotais();
            }

            // INICIALIZAÇÃO DO AUTOCOMPLETE
            $("#search-produto").autocomplete({
                source: function(request, response) {
                    $.get("/Vendas/BuscarProdutos", { termo: request.term }, function(data) {
                        response($.map(data, function(item) {
                            // Mapeia os dados para o formato que o jQuery UI espera
                            // 'label' é o que aparece na lista, 'value' o que vai pro input (opcional)
                            // e 'data' é o objeto completo que guardamos para usar depois
                            return {
                                label: item.nome_produto,
                                value: item.nome_produto,
                                data: item
                            };
                        }));
                    });
                },
                minLength: 2, // Começa a buscar a partir de 2 caracteres
                focus: function(event, ui) {
                    // ATUALIZA A IMAGEM QUANDO O USUÁRIO PASSA O MOUSE/SETA
                    const imgSrc = ui.item.data.imagemBase64 ? ui.item.data.imagemBase64 : imagemPadrao;
                    $('#preview-imagem-produto img').attr('src', imgSrc);
                    return false; // Previne que o valor do input seja preenchido no foco
                },
                select: function(event, ui) {
                    // ADICIONA O ITEM NA TABELA QUANDO SELECIONADO
                    adicionarItem(ui.item.data);

                    // Limpa o campo de busca e reseta a imagem
                    $(this).val('');
                    $('#preview-imagem-produto img').attr('src', imagemPadrao);
                    return false; // Previne que o valor do input seja preenchido na seleção
                }
            });
        });
    </script>
}