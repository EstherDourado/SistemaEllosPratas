@using EllosPratas.Dto
@using System.Globalization
@model List<CarrinhoItemDto>
@{
    ViewData["Title"] = "Controle de Caixa";
    decimal totalVenda = Model.Sum(item => item.Subtotal);
}

<div class="container my-4">
    <!-- Alerta quando caixa está fechado -->
    <div id="alerta-caixa-fechado" class="alert alert-warning d-flex align-items-center" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2 fs-4"></i>
        <div>
            <strong>Atenção!</strong> Você precisa abrir o caixa antes de registrar vendas.
            <button class="btn btn-sm btn-primary ms-3" data-bs-toggle="modal" data-bs-target="#modalGerenciarCaixa">
                <i class="bi bi-box-arrow-right me-1"></i>Abrir Caixa Agora
            </button>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h2 class="h4 mb-0"><i class="bi bi-cart-plus-fill me-2"></i>Registroadww de Venda</h2>
        </div>
        <div class="card-body">
            <form id="form-registrar-venda">

                <fieldset class="border p-3 rounded mb-4">
                    <legend class="float-none w-auto px-2 h6">Informações Gerais</legend>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="select-funcionario" class="form-label"><b>Funcionário</b> <span class="text-danger">*</span></label>
                            <select id="select-funcionario" class="form-select" required>
                                <option value="" selected disabled>Selecione um funcionário...</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="search-cliente" class="form-label">
                                <b>Cliente</b>
                                <span id="cliente-obrigatorio" class="text-danger" style="display: none;">*</span>
                                <span class="text-muted small">(Opcional)</span>
                            </label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" id="search-cliente" class="form-control" placeholder="Buscar cliente por nome ou CPF...">
                                <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#modalNovoCliente">
                                    <i class="bi bi-plus-lg"></i> Cadastrar
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="check-encomenda">
                                <label class="form-check-label" for="check-encomenda">
                                    <i class="bi bi-calendar-check me-1"></i>
                                    <b>É uma encomenda?</b>
                                </label>
                            </div>
                            <small class="text-muted">Ao marcar como encomenda, o cliente se torna obrigatório</small>
                        </div>
                        <div class="col-md-6" id="div-data-encomenda" style="display: none;">
                            <label for="data-entrega-encomenda" class="form-label"><b>Data de Entrega</b></label>
                            <input type="date" id="data-entrega-encomenda" class="form-control">
                        </div>
                    </div>
                </fieldset>

                <fieldset class="border p-3 rounded mb-4">
                    <legend class="float-none w-auto px-2 h6">Itens da Venda</legend>
                    <div class="mb-3">
                        <a href="@Url.Action("Index", "Produtos", new { abrirCarrinho = true })" class="btn btn-outline-primary">
                            <i class="bi bi-plus-circle me-1"></i>Adicionar Produtos ao Carrinho
                        </a>
                    </div>

                    <div class="table-responsive" style="max-height: 350px; overflow-y: auto;">
                        <table class="table table-hover align-middle" id="tabela-itens-venda">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>Produto</th>
                                    <th class="text-center">Quantidade</th>
                                    <th class="text-end">Valor Unitário</th>
                                    <th class="text-end">Subtotal</th>
                                    <th class="text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (!Model.Any())
                                {
                                    <tr>
                                        <td colspan="5" class="text-center text-muted py-4">
                                            <i class="bi bi-cart-x fs-1 d-block mb-2"></i>
                                            Nenhum item no carrinho. Adicione produtos pelo catálogo.
                                        </td>
                                    </tr>
                                }
                                else
                                {
                                    @foreach (var item in Model)
                                    {
                                        <tr data-produto-id="@item.ProdutoId" data-quantidade="@item.Quantidade" data-valor-unitario="@item.ValorUnitario">
                                            <td>@item.NomeProduto</td>
                                            <td class="text-center">
                                                <input type="number" class="form-control form-control-sm input-quantidade" value="@item.Quantidade" min="1" style="width: 70px; margin: 0 auto;">
                                            </td>
                                            <td class="text-end">@item.ValorUnitario.ToString("C")</td>
                                            <td class="text-end fw-bold subtotal-item">@item.Subtotal.ToString("C")</td>
                                            <td class="text-center">
                                                <button type="button" class="btn btn-sm btn-danger btn-remover-item">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>
                            @if (Model.Any())
                            {
                                <tfoot class="table-group-divider">
                                    <tr>
                                        <td colspan="3" class="text-end fs-5 fw-bold">Total dos Itens:</td>
                                        <td class="text-end fs-5 fw-bold" id="total-itens-rodape">@totalVenda.ToString("C")</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            }
                        </table>
                    </div>
                </fieldset>

                <div class="row">
                    <div class="col-lg-7">
                        <div class="card border-info mb-3">
                            <div class="card-header bg-info bg-opacity-10">
                                <h6 class="mb-0"><i class="bi bi-info-circle me-1"></i>Observações da Venda</h6>
                            </div>
                            <div class="card-body">
                                <textarea id="observacoes-venda" class="form-control" rows="4" placeholder="Digite observações adicionais sobre a venda (opcional)..."></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-5">
                        <div class="card border-success">
                            <div class="card-header bg-success bg-opacity-10">
                                <h5 class="mb-0"><i class="bi bi-cash-stack me-1"></i>Resumo e Pagamento</h5>
                            </div>
                            <div class="card-body">
                                <ul class="list-group list-group-flush mb-3">
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>Subtotal</span>
                                        <span id="resumo-subtotal" class="fw-bold">R$ 0,00</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>Desconto</span>
                                        <div class="input-group input-group-sm" style="width: 130px;">
                                            <span class="input-group-text">R$</span>
                                            <input type="number" id="input-desconto" class="form-control" value="0.00" min="0" step="0.01">
                                        </div>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center bg-light">
                                        <span class="fw-bold fs-5">TOTAL</span>
                                        <span id="resumo-total" class="text-success fw-bold fs-4">R$ 0,00</span>
                                    </li>
                                </ul>

                                <div class="mb-3">
                                    <label for="select-pagamento" class="form-label"><b>Forma de Pagamento</b> <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <select id="select-pagamento" class="form-select" required>
                                            <option value="" selected disabled>Selecione...</option>
                                        </select>
                                        <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#modalNovaFormaPagamento">
                                            <i class="bi bi-plus-lg"></i>
                                        </button>
                                    </div>
                                </div>

                                <div class="mb-3" id="div-parcelas" style="display: none;">
                                    <label for="select-parcelas" class="form-label"><b>Parcelas</b></label>
                                    <select id="select-parcelas" class="form-select">
                                        <option value="1">1x sem juros</option>
                                        <option value="2">2x sem juros</option>
                                        <option value="3">3x sem juros</option>
                                        <option value="6">6x sem juros</option>
                                        <option value="12">12x sem juros</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between mt-4">
                    <button type="button" class="btn btn-secondary" id="btn-limpar">
                        <i class="bi bi-arrow-clockwise me-1"></i>Limpar Campos
                    </button>
                    <button type="submit" class="btn btn-primary btn-lg" id="btn-finalizar-venda" disabled>
                        <i class="bi bi-check-circle-fill me-2"></i>Finalizar Venda
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal: Novo Cliente -->
<div class="modal fade" id="modalNovoCliente" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cadastro Rápido de Cliente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted">Funcionalidade de cadastro rápido será implementada aqui.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary">Salvar Cliente</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Nova Forma de Pagamento -->
<div class="modal fade" id="modalNovaFormaPagamento" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nova Forma de Pagamento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="form-nova-forma-pagamento">
                    <div class="mb-3">
                        <label for="nome_forma" class="form-label">Nome</label>
                        <input type="text" id="nome_forma" name="nome_forma" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="descricao_forma" class="form-label">Descrição (Opcional)</label>
                        <textarea id="descricao_forma" name="descricao" class="form-control" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" id="btn-salvar-forma-pagamento" class="btn btn-primary">Salvar</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            let caixaAberto = false;
            let idCaixaAtual = null;
            let idLojaAtual = null;

            // ===== FUNÇÕES AUXILIARES =====
            function formatCurrency(value) {
                return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            }

            function atualizarStatusCaixa(aberto, dados = {}) {
                caixaAberto = aberto;
                if (aberto) {
                    idCaixaAtual = dados.id_caixa;
                    $('#status-caixa-info').html(`
                        <span class="badge bg-success fs-6">
                            <i class="bi bi-check-circle me-1"></i>Caixa Aberto
                        </span>
                    `);
                    $('#alerta-caixa-fechado').hide();
                    $('#btn-finalizar-venda').prop('disabled', false);
                    $('#status-caixa-aberto').show();
                    $('#form-abrir-caixa').hide();
                    $('#caixa-funcionario').text(dados.funcionario || 'N/A');
                    $('#caixa-data-abertura').text(dados.data_abertura || 'N/A');
                } else {
                    idCaixaAtual = null;
                    $('#status-caixa-info').html(`
                        <span class="badge bg-danger fs-6">
                            <i class="bi bi-x-circle me-1"></i>Caixa Fechado
                        </span>
                    `);
                    $('#alerta-caixa-fechado').show();
                    $('#btn-finalizar-venda').prop('disabled', true);
                    $('#status-caixa-aberto').hide();
                    $('#form-abrir-caixa').show();
                }
            }

            function calcularTotais() {
                let subtotal = 0;
                $('#tabela-itens-venda tbody tr').each(function() {
                    const qtd = parseInt($(this).find('.input-quantidade').val()) || 0;
                    const valorUnitario = parseFloat($(this).data('valor-unitario')) || 0;
                    const itemSubtotal = qtd * valorUnitario;
                    subtotal += itemSubtotal;
                    $(this).find('.subtotal-item').text(formatCurrency(itemSubtotal));
                });

                const desconto = (parseFloat($('#input-desconto').val()) * subtotal) / 100 || 0;
                const total = subtotal - desconto;

                $('#resumo-subtotal').text(formatCurrency(subtotal));
                $('#resumo-total').text(formatCurrency(total));
                $('#total-itens-rodape').text(formatCurrency(subtotal));
            }

            // ===== CONTROLE DE ENCOMENDA =====
            $('#check-encomenda').on('change', function() {
                if ($(this).is(':checked')) {
                    $('#div-data-encomenda').slideDown();
                    $('#cliente-obrigatorio').show();
                    $('#search-cliente').attr('required', true);
                } else {
                    $('#div-data-encomenda').slideUp();
                    $('#cliente-obrigatorio').hide();
                    $('#search-cliente').attr('required', false);
                }
            });

            // ===== CONTROLE DE QUANTIDADE E REMOÇÃO =====
            $(document).on('input', '.input-quantidade', calcularTotais);
            $(document).on('click', '.btn-remover-item', function() {
                $(this).closest('tr').remove();
                calcularTotais();
            });

            $('#input-desconto').on('input', calcularTotais);

           
            // ===== FORMAS DE PAGAMENTO =====
            async function carregarFormasPagamento() {
                try {
                    const response = await fetch('@Url.Action("ListarFormasPagamento", "Vendas")');
                    const formas = await response.json();
                    const select = $('#select-pagamento');
                    select.empty().append('<option value="" selected disabled>Selecione...</option>');
                    formas.forEach(forma => {
                        select.append(new Option(forma.nome_forma, forma.id_forma_pagamento));
                    });
                } catch (error) {
                    console.error(error);
                }
            }

            $('#select-pagamento').on('change', function() {
                const formaSelecionada = $(this).find('option:selected').text().toLowerCase();
                if (formaSelecionada.includes('cartão') || formaSelecionada.includes('cartao') || formaSelecionada.includes('crédito') || formaSelecionada.includes('credito')) {
                    $('#div-parcelas').slideDown();
                } else {
                    $('#div-parcelas').slideUp();
                }
            });

            $('#btn-salvar-forma-pagamento').on('click', async function() {
                const dto = {
                    nome_forma: $('#nome_forma').val(),
                    descricao: $('#descricao_forma').val()
                };
                try {
                    const response = await fetch('@Url.Action("CadastrarFormaPagamento", "Vendas")', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dto)
                    });
                    const novaForma = await response.json();
                    $('#select-pagamento').append(new Option(novaForma.nome_forma, novaForma.id_forma_pagamento, true, true));
                    bootstrap.Modal.getInstance($('#modalNovaFormaPagamento')).hide();
                    $('#form-nova-forma-pagamento')[0].reset();
                } catch (error) {
                    alert("Erro ao salvar forma de pagamento.");
                }
            });

            // ===== FINALIZAR VENDA =====
            $('#form-registrar-venda').on('submit', async function(e) {
                e.preventDefault();

                if (!caixaAberto) {
                    alert('Você precisa abrir o caixa antes de registrar uma venda!');
                    return;
                }

                // TODO: Implementar envio da venda
                alert('Venda registrada com sucesso!');
            });

            $('#btn-limpar').on('click', function() {
                if (confirm('Deseja limpar todos os campos?')) {
                    $('#form-registrar-venda')[0].reset();
                    calcularTotais();
                }
            });

            // ===== INICIALIZAÇÃO =====
            calcularTotais();
            carregarFormasPagamento();
        });
    </script>
}