@using EllosPratas.Dto;
@using EllosPratas.Services.Categoria
@model ProdutosCriacaoDto;

@inject ICategoriasInterface CategoriasServices

@{
    bool isEditMode = Model != null && Model.id_produto > 0;
    ViewData["Title"] = isEditMode ? "Editar Produto" : "Cadastrar Produto";
    var actionName = isEditMode ? "Editar" : "Cadastrar";
    var imagemPadrao = Url.Content("~/imagens/produto_padrao.png");
    var categorias = CategoriasServices.GetCategorias().Result; // <- Corrigido aqui
}

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0/dist/js/select2.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<div class="container mt-5">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">@ViewData["Title"]</h4>
        </div>
        <div class="card-body">
            @if (!isEditMode)
            {
                <ul class="nav nav-tabs" id="tabsCadastro" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#produto" type="button">Produto</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#categoriaCadastra" type="button">Cadastrar Categoria</button>
                    </li>
                </ul>
            }

            <div class="tab-content mt-4">

                <div class="tab-pane fade show active" id="produto" role="tabpanel" aria-labelledby="produto-tab">
                    <form id="produtosForm" asp-controller="Produtos" asp-action="Cadastrar" method="post">
                        @if (isEditMode)
                        {
                            <input type="hidden" asp-for="id_produto" />
                        }

                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label asp-for="nome_produto" class="form-label">Nome do Produto</label>
                                    <input asp-for="nome_produto" id="nome_produto" name="nome_produto" class="form-control" required>
                                    <span asp-validation-for="nome_produto" class="text-danger"></span>
                                </div>
                                <div class="mb-3">
                                    <label asp-for="descricao" class="form-label">Descrição</label>
                                    <textarea asp-for="descricao" id="descricao" name="descricao" class="form-control" rows="2" required></textarea>
                                    <span asp-validation-for="descricao" class="text-danger"></span>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Preço de Venda</label>
                                        <input asp-for="valor_unitario" id="valor_unitario" name="valor_unitario" class="form-control" required value="@(isEditMode? Model!.valor_unitario.ToString("N2") : "0,00")">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Quantidade Estoque</label>
                                        <input asp-for="quantidade" id="quantidade" name="quantidade" class="form-control" required value="@(isEditMode? Model!.quantidade.ToString() : "0")">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label asp-for="id_categoria" class="form-label">Categoria</label>
                                    <select asp-for="id_categoria" class="form-control" id="id_categoria" name="id_categoria" style="width:100%" required>
                                        <option value="">Selecione...</option>
                                        @foreach (var cat in categorias)
                                        {
                                            
                                            if (isEditMode && Model!.id_categoria == cat.id_categoria)
                                            {
                                                <option value="@cat.id_categoria" selected>@cat.nome_categoria</option>
                                            }
                                            else
                                            {
                                                <option value="@cat.id_categoria">@cat.nome_categoria</option>
                                            }
                                        }
                                    </select>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label asp-for="ativo" class="form-label">Ativo</label>
                                        <select asp-for="ativo" class="form-select" required>
                                            <option value="true">Sim</option>
                                            <option value="false">Não</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center">
                                    <label for="ImageFile">
                                        @{
                                            var imgSrc = imagemPadrao;
                                            if (isEditMode && ViewBag.ImagemAtual != null)
                                            {
                                                imgSrc = $"data:image/png;base64,{Convert.ToBase64String(ViewBag.ImagemAtual)}";
                                            }
                                        }
                                        <img id="imgPreview" src="@imgSrc" class="img-thumbnail" style="width:200px; height: 200px; object-fit: cover; cursor:pointer;" alt="Imagem do Produto" />
                                    </label>
                                </div>
                                <div class="mb-3 mt-2">
                                    <label for="imagen" class="form-label">Trocar Imagem</label>
                                    <input type="file" class="form-control" name="imagem" id="ImageFile" accept="image/*">
                                </div>
                            </div>
                        </div>

                        <hr />
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="/Produtos/Index" class="btn btn-outline-secondary">Cancelar</a>
                            <button type="submit" class="btn btn-primary">@(isEditMode ? "Salvar Alterações" : "Cadastrar Produto")</button>
                        </div>
                    </form>
                </div>

                <div class="tab-pane fade" id="categoriaCadastra" role="tabpanel" aria-labelledby="categoria-tab">
                    <div class="row">
                        <div class="col-md-5">
                            <h4>Nova Categoria</h4>
                            <form id="formCategoria" class="mt-3">
                                <div class="mb-3">
                                    <label for="nomeCategoria" class="form-label">Nome da Categoria</label>
                                    <input type="text" class="form-control" id="nomeCategoria" name="nome_categoria" required>
                                </div>
                                <button type="submit" class="btn btn-success">Adicionar Nova Categoria</button>
                            </form>
                        </div>
                        <div class="col-md-7">
                            <h4>Categorias Existentes</h4>
                            <div id="lista-categorias-container" class="list-group mt-3" style="max-height: 300px; overflow-y: auto;">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal fade" id="editCategoriaModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="editModalLabel">Editar Categoria</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <form id="formEditCategoria">
                                <div class="modal-body">
                                    <input type="hidden" id="editCategoriaId" name="id_categoria">
                                    <div class="mb-3">
                                        <label for="editCategoriaNome" class="form-label">Nome da Categoria</label>
                                        <input type="text" class="form-control" id="editCategoriaNome" name="nome_categoria" required>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                                    <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />


<script>
    // Corrigindo a prévia da imagem
    const inputFile = document.querySelector("#ImageFile");
    inputFile.addEventListener("change", function(e){
        const inputTarget = e.target;
        const file = inputTarget.files[0];

        if(file){
            const reader = new FileReader();
            reader.addEventListener("load", function (e){
                const readerTarget = e.target;
                const img = document.querySelector("#imgPreview");
                img.src = readerTarget.result;
            });
            reader.readAsDataURL(file);
        }
    });

    $(document).ready(function () {
        $('#valor_unitario').mask('#.##0,00', {reverse: true});
        $('#quantidade').mask('0#');

        $('#valor_unitario').on('focus', function() { if ($(this).val() === '0,00') $(this).val(''); });
        $('#quantidade').on('focus', function() { if ($(this).val() === '0') $(this).val(''); });

        $('#produtosForm').on('submit', function(e) {
            e.preventDefault();
            var postUrl = $(this).attr('action');
            var formData = new FormData(this);

            var valorMascarado = $('#valor_unitario').val();

            if (valorMascarado) {
                formData.set('valor_unitario', valorMascarado.replace(/\./g, '').replace(',', '.'));
            }


            for (let [chave, valor] of formData.entries()) {
                console.log(chave + ':', valor);
            }


            $.ajax({
                type: 'POST',
                url: postUrl,
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    console.log("Retorno: ",response);

                    if (response.success) {
                        alert(response.message);
                        $('#produtosForm')[0].reset();
                        selectCategoria.val(null).trigger('change');
                        $('#imgPreview').attr('src', '@imagemPadrao');
                        $('input[name="nome_produto"]').focus();
                        $('#valor_unitario').val('0,00');
                        $('#quantidade').val('0');
                    }
                },
                error: function(xhr, status, error) {
                    var response = xhr.responseJSON;
                    if (response && response.message) {
                        alert(response.message);
                    } else {
                        alert("Ocorreu um erro inesperado. Tente novamente.");
                    }
                }
            });
        });

        const isEditMode = @isEditMode.ToString().ToLower();
        const selectCategoria = $('#categoria');

        if (isEditMode) {
            const categoriaAtualId = @Model!.id_categoria;
            const categoriaAtualNome = '@(ViewBag.CategoriaAtualNome ?? "")';
            if (categoriaAtualNome) {
                var option = new Option(categoriaAtualNome, categoriaAtualId, true, true);
                selectCategoria.append(option);
                selectCategoria.trigger('change');
            }
        }

        // Select2 para categoria, carrega id e nome corretamente
        $('#categoria').select2({
            placeholder: "Selecione ou digite para buscar",
            allowClear: true,
            ajax: {
                url: '/Categorias/Listar',
                dataType: 'json',
                delay: 250,
                data: function (params) {
                    return { q: params.term }; // 'q' é o termo da busca
                },
                processResults: function (data) {
                    return { results: data };
                },
                cache: true
            }
        });

        // Cadastrar nova categoria
        $('#formCategoria').submit(function (e) {
            e.preventDefault();
            $.post('/Categorias/Cadastrar', $(this).serialize())
                .done(function (novaCategoria) {
                    alert('Categoria cadastrada com sucesso!');
                    $('#formCategoria')[0].reset();
                    carregarListaCategorias();
                    var option = new Option(novaCategoria.nome_categoria, novaCategoria.id_categoria, true, true);
                    $('#categoria').append(option).trigger('change');
                })
                .fail(function (xhr) { alert('Erro: ' + xhr.responseText); });
        });

        // Listar todas categorias
        function carregarListaCategorias() {
            var listaContainer = $('#lista-categorias-container');
            listaContainer.html('<p>Carregando...</p>');
            $.get('/Categorias/ListarTodas')
                .done(function (categorias) {
                    listaContainer.empty();
                    if (!categorias || categorias.length === 0) {
                        listaContainer.html('<p class="text-muted">Nenhuma categoria cadastrada.</p>');
                        return;
                    }
                    categorias.forEach(function (cat) {
                        const statusBadge = cat.ativo
                            ? '<span class="badge bg-success">Ativo</span>'
                            : '<span class="badge bg-secondary">Inativo</span>';
                        const statusButtonText = cat.ativo ? 'Inativar' : 'Ativar';
                        const statusButtonClass = cat.ativo ? 'btn-outline-warning' : 'btn-outline-info';
                        const itemHtml = `
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    ${cat.nome_categoria} ${statusBadge}
                                </div>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-sm btn-outline-primary btn-editar" data-id="${cat.id_categoria}" data-nome="${cat.nome_categoria}">Editar</button>
                                    <button type="button" class="btn btn-sm ${statusButtonClass} btn-status" data-id="${cat.id_categoria}">${statusButtonText}</button>
                                </div>
                            </div>
                        `;
                        listaContainer.append(itemHtml);
                    });
                })
                .fail(function () {
                    listaContainer.html('<p class="text-danger">Erro ao carregar categorias.</p>');
                });
        }

        carregarListaCategorias();

        // Evento para abrir o modal de edição
        $('#lista-categorias-container').on('click', '.btn-editar', function () {
            const id = $(this).data('id');
            const nome = $(this).data('nome');
            $('#editCategoriaId').val(id);
            $('#editCategoriaNome').val(nome);
            var editModal = new bootstrap.Modal(document.getElementById('editCategoriaModal'));
            editModal.show();
        });

        // Evento para salvar a edição
        $('#formEditCategoria').submit(function (e) {
            e.preventDefault();
            $.post('/Categorias/Editar', $(this).serialize())
                .done(function () {
                    alert('Categoria atualizada com sucesso!');
                    var editModal = bootstrap.Modal.getInstance(document.getElementById('editCategoriaModal'));
                    editModal.hide();
                    carregarListaCategorias();
                    $('#categoria').empty().trigger('change');
                })
                .fail(function () { alert('Erro ao atualizar categoria.'); });
        });

        // Evento para alterar o status
        $('#lista-categorias-container').on('click', '.btn-status', function () {
            const id = $(this).data('id');
            if (confirm('Tem certeza que deseja alterar o status desta categoria?')) {
                $.post('/Categorias/AlterarStatus', { id: id })
                    .done(function () {
                        carregarListaCategorias();
                        $('#categoria').empty().trigger('change');
                    })
                    .fail(function () { alert('Erro ao alterar status.'); });
            }
        });
    });
</script>
}