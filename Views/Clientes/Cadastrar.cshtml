@using EllosPratas.Dto
@using EllosPratas.Dto.Clientes.Entrada
@model ClienteDto

@{
    // Lógica para detectar o modo de edição
    bool isEditMode = Model != null && Model.id_cliente > 0;
    ViewData["Title"] = isEditMode ? "Editar Cliente" : "Cadastrar Cliente";
    var actionName = isEditMode ? "Editar" : "Cadastrar";
}

<div class="container mt-5">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">@ViewData["Title"]</h4>
        </div>
        <div class="card-body">
            
            <form id="clienteForm" asp-controller="Clientes" asp-action="@actionName" method="post">
                @if (isEditMode)
                {
                    <input type="hidden" asp-for="id_cliente" />
                }
                
                @Html.AntiForgeryToken()

                <div class="row">
                    <div class="col-md-12">
                        
                        <div class="mb-3">
                            <label asp-for="nome_cliente" class="form-label"></label>
                            <input asp-for="nome_cliente" class="form-control" required>
                            <span asp-validation-for="nome_cliente" class="text-danger"></span>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="cpf" class="form-label"></label>
                                <input asp-for="cpf" id="cpf" class="form-control" required placeholder="000.000.000-00">
                                <span asp-validation-for="cpf" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="telefone" class="form-label"></label>
                                <input asp-for="telefone" id="telefone" class="form-control" required placeholder="(00) 00000-0000">
                                <span asp-validation-for="telefone" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="email" class="form-label"></label>
                            <input asp-for="email" type="email" class="form-control" required>
                            <span asp-validation-for="email" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="ativo" class="form-label"></label>
                            <select asp-for="ativo" class="form-select" required>
                                <option value="true">Sim</option>
                                <option value="false">Não</option>
                            </select>
                        </div>
                    </div>
                </div>

                <hr />
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <a href="/Home/Index" class="btn btn-outline-secondary">Cancelar</a>
                    <button type="submit" class="btn btn-primary">@(isEditMode ? "Salvar Alterações" : "Cadastrar Cliente")</button>
                </div>
            </form>

        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    <script>
        $(document).ready(function(){
            $('#cpf').mask('000.000.000-00', {reverse: true});
            $('#telefone').mask('(00) 00000-0000');

            $('#clienteForm').on('submit', function(e) {
                e.preventDefault();

                var postUrl = $(this).attr('action');

                var formData = $(this).serialize();

                $.ajax({
                    type: 'POST',
                    url: postUrl,
                    data: formData,
                    success: function(response) {
                        if (response.success) {
                            alert(response.message);
                            window.location.href = '@Url.Action("Index", "Home")';
                        }
                    },
                    error: function(xhr, status, error) {
                        // O objeto 'xhr' contém a resposta do servidor.
                        // 'xhr.responseJSON' já converte a resposta para um objeto JavaScript.
                        var response = xhr.responseJSON;

                        // Verificamos se a resposta contém a nossa propriedade 'message'
                        if (response && response.message) {
                            // Se sim, exibimos a mensagem de erro vinda do back-end
                            alert(response.message);
                        } else {
                            // Caso contrário (para outros tipos de erro), exibimos a mensagem genérica
                            alert("Ocorreu um erro inesperado. Tente novamente.");
                        }
                    }
                });
            });
        });
    </script>
}